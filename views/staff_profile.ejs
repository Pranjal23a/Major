<link rel="stylesheet" type="text/css" href="/css/staff_profile.css">
<% if(locals.user){ %>
    <div class="main-container">

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
                aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">

                <a class="navbar-brand" href=" /staff/profile">Update Inventory</a>
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item active">

                        <a class="nav-link" href=" /staff/search">Search Inventory <span
                                class="sr-only">(current)</span></a>

                    </li>
                    <li class="nav-item ">

                        <a class="nav-link" href=" /staff/patient">View Patient <span
                                class="sr-only">(current)</span></a>
                    </li>


                </ul>
            </div>
        </nav>





        <!-- isko bhi side mai as a list add krio -->

        <div class="container-fluid">
            <div class="row">
                <div class="col">

                    <div class="title-edit">
                        <h3>Update Inventory</h3>
                    </div>

                    <div class="form-container">
                        <div class="form-container">
                            <form action="/inventory/drop" method="POST">
                                <input class="form-style-place" type="text" name="buyer_name" placeholder="Buyer's Name"
                                    required>
                                <input class="form-style-place" type="tel" name="mobile_number"
                                    placeholder="Mobile Number" required>
                                <div class="form-style" id="inputFieldsContainer">
                                    <!-- Dynamic input fields -->
                                    <input class="form-style-place" type="text" name="medicine_id[]"
                                        placeholder="Medicine ID" required>
                                    <input class="form-style-place" type="number" name="stock[]" placeholder="Unit Sell"
                                        required>

                                    <!-- More dynamically added fields go here -->
                                </div>
                                <button type="button" id="addInputField">Add Item</button>
                                <input class="enter" type="submit" value="Update">
                            </form>

                        </div>

                    </div>
                </div>
                <div class="col">
                    <button id="downloadPDFButton">Download Bill</button>
                    <table border="1" style="text-align: center;">
                        <thead>
                            <th>Medicine ID</th>
                            <th>Name</th>
                            <th>Stock</th>
                            <th>Price(per Unit)</th>
                            <th>Expiry Date</th>
                        </thead>
                        <tbody>
                            <% for(info of data){%>
                                <tr>
                                    <td>
                                        <%= info.medicine_id %>
                                    </td>
                                    <td>
                                        <%= info.name%>
                                    </td>
                                    <td>
                                        <%= info.stock %> U
                                    </td>
                                    <td>
                                        Rs. <%= info.price %>
                                    </td>
                                    <td style="<%=checkExpiration(info.exp_date) %>">
                                        <%= new Date(info.exp_date).toLocaleDateString('en-US', { year: 'numeric' ,
                                            month: 'short' , day: 'numeric' }) %>
                                    </td>
                                </tr>
                                <% } %>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>


    </div>

    <% } %>
        <script>
        <% function checkExpiration(expDate) {
                var currentDate = new Date();
                var expirationDate = new Date(expDate);
                var timeDifference = expirationDate - currentDate;
                var daysUntilExpiration = Math.floor(timeDifference / (1000 * 60 * 60 * 24));

                if (daysUntilExpiration < 0) {
                    return " background-color: red;";
                } else if (daysUntilExpiration <= 30) {
                    return "background-color: orange;";
                } else { return ""; }
            }
                %>
                // Use jQuery to add a click event handler to the button
                $(document).ready(function () {
                    $('#downloadPDFButton').click(function () {
                        const userId = '<%= user._id %>';
                        window.open(`/inventory/download-pdf/${userId}`, '_blank');
                    });
                });

            $(document).ready(function () {
                $('#addInputField').click(function () {
                    // Clone the initial input fields
                    const inputFieldsContainer = $('#inputFieldsContainer');
                    const clonedInputFields = inputFieldsContainer.clone(true);

                    // Clear the values of the cloned input fields
                    clonedInputFields.find('input').val('');

                    // Update the names of the cloned input fields with unique indexes
                    const index = inputFieldsContainer.find('.form-style-place').length / 2; // Two inputs per item
                    clonedInputFields.find('input[name="medicine_id[]"]').attr('name', `medicine_id[${index}]`);
                    clonedInputFields.find('input[name="stock[]"]').attr('name', `stock[${index}]`);

                    // Add the cloned input fields at the top of the form
                    inputFieldsContainer.after(clonedInputFields);
                });

                $('#updateInventoryForm').submit(function (event) {
                    event.preventDefault(); // Prevent the default form submission

                    // Collect data from dynamically added input fields
                    const formData = $(this).serializeArray();

                    // Use formData to send the data to the server using AJAX
                    $.ajax({
                        type: 'POST',
                        url: '/inventory/drop',
                        data: formData,
                        success: function (data) {
                            // Handle the response from the server (if needed)
                            console.log('Form submitted successfully', data.data.pdfFilePath);
                            // You can update the UI or perform other actions here
                        },
                        error: function (error) {
                            console.error('Form submission failed', error);
                            // Handle errors or display error messages here
                        }
                    });
                });
            });

        </script>